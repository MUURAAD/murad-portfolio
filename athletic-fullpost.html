<!DOCTYPE html>
<html lang="en" data-theme="light" data-accent="green">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="dynamic-title">Loading Athletic Post...</title> <!-- Dynamic Title -->

  <!-- Bootstrap + Icons + Fonts (Consistent) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    /* ----------------- THEME & ACCENT VARIABLES (Consistent) ----------------- */
    :root{
      --bg: #f4f7fb; --card-bg: #ffffff; --muted: #596a75;
      --primary: #20c997; --primary-700:#179b77;
      --glass: rgba(255,255,255,0.6); --shadow: 0 10px 30px rgba(16,24,40,0.08);
      --radius: 14px; --accent-shadow: 0 12px 30px rgba(32,201,151,0.14);
      --nav-height: 64px; --max-content-width: 960px; /* Max width for readability */
    }
    [data-theme="dark"]{
      --bg: #0b1220; --card-bg: #0f1b28; --muted: #b6cad6;
      --primary: #43d9b2; --primary-700:#2fbf9a;
      --glass: rgba(255,255,255,0.03); --shadow: 0 12px 40px rgba(0,0,0,0.7);
      --accent-shadow: 0 12px 30px rgba(67,217,178,0.08);
    }
    [data-accent="green"] { --primary: #20c997; --primary-700: #179b77; --accent-shadow: 0 12px 30px rgba(32,201,151,0.14); }
    [data-accent="yellow"] { --primary: #f1c40f; --primary-700: #d4a70b; --accent-shadow: 0 12px 30px rgba(241,196,15,0.12); }
    [data-accent="red"] { --primary: #e74c3c; --primary-700: #c0382b; --accent-shadow: 0 12px 30px rgba(231,76,60,0.12); }

    html,body{height:auto; min-height: 100%;}
    body{
      margin:0; font-family:'Comfortaa',sans-serif;
      background:var(--bg); color:var(--muted);
      transition: background .35s ease, color .35s ease;
      padding-top: var(--nav-height);
      padding-bottom: 60px; /* Space for quote bar */
    }
    .container-xl{ max-width: var(--max-content-width); }
    .shadow-soft{ box-shadow: var(--shadow); }
    .glass{ background: var(--glass); border-radius: 10px; }

    /* NAVBAR (Consistent) */
    .navbar-custom{ height: var(--nav-height); background: linear-gradient(90deg, rgba(0,0,0,0.04), rgba(255,255,255,0.02)); backdrop-filter: blur(6px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .logo-img { height: 40px; width: auto; object-fit: contain; border-radius: 50%; border: 2px solid var(--primary); transition: border-color 0.3s ease; }
    .nav-link{ color:var(--muted) !important; padding:8px 14px; border-radius:8px; font-weight:600; }
    .nav-link:hover{ background: rgba(0,0,0,0.04); color:var(--primary) !important; transform: translateY(-3px); }
    .accent-palette { display:flex; gap:8px; align-items:center; }
    .accent-dot { width:18px; height:18px; border-radius:50%; cursor:pointer; border:2px solid rgba(255,255,255,0.9); box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .accent-dot[aria-checked="true"] { transform: scale(1.15); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }
    @media (max-width: 991.98px) { .navbar-collapse.show { background: var(--card-bg); padding: 16px; border-radius: var(--radius); margin-top: 8px; box-shadow: var(--shadow); display: block; } .navbar-collapse.show .navbar-nav .nav-link { padding: 10px 12px; } }

    /* --- FULL POST LAYOUT --- */
    .post-container { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 30px; margin-bottom: 30px; overflow: hidden; }
    .hero-image-container { height: 400px; position: relative; background-size: cover; background-position: center; background-color: var(--glass); /* Placeholder bg */ }
    .hero-image-container::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
    .hero-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 30px 40px; color: white; z-index: 1; }
    .hero-content h1 { font-size: 2.5rem; font-weight: 700; color: white !important; text-shadow: 0 2px 5px rgba(0,0,0,0.5); margin-bottom: 8px; display: flex; align-items: center; gap: 10px;} /* Flex for icon */
    .post-meta { font-size: 0.9rem; opacity: 0.85; }
    .post-meta span { margin-right: 15px; display: inline-flex; align-items: center; } /* Align icons */
    .post-meta i { margin-right: 5px; opacity: 0.7; }
    .post-body { padding: 30px 40px; }
    @media (max-width: 768px) { .hero-image-container { height: 300px; } .hero-content { padding: 20px; } .hero-content h1 { font-size: 1.8rem; } .post-body { padding: 20px; } }
    /* FIXED Drop Cap Scope */
    #mainContent > p:first-of-type::first-letter { font-size: 4rem; font-weight: bold; color: var(--primary); float: left; margin: 0 10px 0 0; line-height: 0.8; }
    .post-body p { line-height: 1.7; margin-bottom: 1.5rem; font-size: 1rem; }
    .post-body h2, .post-body h3 { color: var(--primary-700) !important; margin-top: 2rem; margin-bottom: 1rem; }
    [data-theme="dark"] .post-body h2, [data-theme="dark"] .post-body h3 { color: var(--primary) !important; }
    .post-body blockquote { border-left: 4px solid var(--primary); padding-left: 15px; margin: 1.5rem 0; font-style: italic; color: var(--muted); opacity: 0.9; }
    .post-actions { display: flex; align-items: center; justify-content: space-between; padding: 15px 40px; border-top: 1px solid var(--glass); }
    .like-btn { background: none; border: none; color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1rem; padding: 8px 12px; border-radius: 50px; transition: all 0.2s ease; }
    .like-btn:hover { background: var(--glass); color: var(--primary); }
    .like-btn .fa-heart { font-size: 1.2rem; }
    .like-btn.liked { color: var(--primary); }
    .share-btn { background: none; border: none; color: var(--muted); cursor: pointer; padding: 8px 12px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-size: 1rem; transition: all 0.2s ease; }
    .share-btn:hover { background: var(--glass); color: var(--primary); }
    .share-btn i { font-size: 1.1rem; }
    .stats-card { background: var(--glass); border-radius: var(--radius); padding: 20px; margin-bottom: 25px; }
    .stats-card h3 { font-size: 1.1rem; color: var(--primary-700) !important; margin-bottom: 15px; }
    [data-theme="dark"] .stats-card h3 { color: var(--primary) !important; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center; }
    .stat-item .value { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: block; }
    .stat-item .label { font-size: 0.8rem; opacity: 0.8; }
    .map-placeholder { border-radius: var(--radius); overflow: hidden; margin-bottom: 25px; border: 1px solid var(--glass); position: relative; } /* Added relative */
    .map-placeholder img { display: block; max-width: 100%; height: auto; }
    .map-placeholder p { text-align: center; font-size: 0.8rem; padding: 8px; margin: 0; background: var(--glass); }
    /* NEW: Map Overlay */
    .map-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .map-placeholder:hover .map-overlay { opacity: 1; }
    .map-overlay i { font-size: 2rem; color: white; }

    .info-card { background: var(--glass); border-radius: var(--radius); padding: 15px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
    .info-card i { font-size: 1.8rem; color: var(--primary); opacity: 0.8; flex-shrink: 0; }
    .info-card h4 { font-size: 0.9rem; font-weight: 600; color: var(--primary-700); margin-bottom: 3px; }
    [data-theme="dark"] .info-card h4 { color: var(--primary); }
    .info-card p { font-size: 0.85rem; margin-bottom: 0; line-height: 1.4; }
    .focus-callout { border-left: 4px solid var(--primary); background: var(--glass); padding: 15px; border-radius: 8px; margin: 1.5rem 0; font-style: italic; }
    .focus-callout strong { color: var(--primary-700); }
    [data-theme="dark"] .focus-callout strong { color: var(--primary); }
    .author-bio { display: flex; align-items: center; gap: 15px; background: var(--glass); padding: 20px; border-radius: var(--radius); margin-top: 30px; }
    .author-bio img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
    .author-bio p { font-size: 0.9rem; margin-bottom: 0; }
    .author-bio strong { color: var(--primary-700); }
    [data-theme="dark"] .author-bio strong { color: var(--primary); }
    .related-posts { margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--glass); }
    .related-posts h2 { font-size: 1.5rem; text-align: center; margin-bottom: 25px; color: var(--primary-700) !important; }
    [data-theme="dark"] .related-posts h2 { color: var(--primary) !important; }
    .related-posts .blog-grid { /* Reuse blog grid */ }
    .blog-card-v2 { display: flex; flex-direction: column; background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--glass); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: all 0.3s cubic-bezier(.17,.67,.26,1.24); }
    .blog-card-v2:hover { transform: perspective(1000px) translateY(-8px) rotateX(3deg); box-shadow: var(--accent-shadow); border-color: var(--primary); }
    .blog-card-v2-image { height: 180px; position: relative; background-size: cover; background-position: center; overflow: hidden; background-color: var(--glass);} /* Placeholder BG */
    .blog-card-v2-tag { position: absolute; top: 12px; left: 12px; background: var(--glass); backdrop-filter: blur(5px); color: var(--muted); padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; border: 1px solid var(--glass); }
    .blog-card-v2-content { padding: 16px; display: flex; flex-direction: column; flex-grow: 1; }
    .blog-card-v2-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 8px; }
    .blog-card-v2-title { font-size: 1.15rem; color: var(--primary-700); font-weight: 700; margin-bottom: 8px; }
    [data-theme="dark"] .blog-card-v2-title { color: var(--primary); }
    .blog-card-v2-excerpt { font-size: 0.9rem; flex-grow: 1; margin-bottom: 12px; }
    .blog-card-v2-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--glass); padding-top: 12px; }
    .comment-section { margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--glass); }
    .comment-section h2 { font-size: 1.5rem; text-align: center; margin-bottom: 25px; color: var(--primary-700) !important; }
    [data-theme="dark"] .comment-section h2 { color: var(--primary) !important; }
    #comment-form .form-control { background: var(--glass); border-color: transparent; color: var(--muted); margin-bottom: 10px; }
    #comment-form .form-control::placeholder { color: var(--muted); opacity: 0.7; }
    #comment-list .list-group-item { background: var(--glass); border-color: transparent; margin-bottom: 10px; border-radius: 8px; }
    #comment-list h5 { font-size: 1rem; color: var(--primary-700); font-weight: 600; }
    [data-theme="dark"] #comment-list h5 { color: var(--primary); }
    #comment-list p { font-size: 0.9rem; margin-bottom: 0; }
    #comment-list small.text-muted { font-size: 0.8rem; display: block; margin-top: 5px;}
    .ai-summary-section { margin-top: 30px; padding: 20px; background: var(--glass); border-radius: var(--radius); }
    .ai-summary-section h3 { font-size: 1.1rem; color: var(--primary-700) !important; margin-bottom: 10px; }
    [data-theme="dark"] .ai-summary-section h3 { color: var(--primary) !important; }
    #aiSummaryContent { font-size: 0.9rem; font-style: italic; opacity: 0.9; display: none; margin-top: 10px; }
    #aiSummaryLoading { display: none; font-weight: 600; font-size: 0.9rem; }
    #readingProgress { position: fixed; top: var(--nav-height); left: 0; height: 4px; background: var(--primary); width: 0%; z-index: 1001; transition: width 0.1s linear; }
    .fab, #quoteCard, #toastNotification { /* ... */ }
    .fab{ position:fixed; bottom:28px; right:28px; width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:var(--primary); color:#fff; box-shadow:0 20px 40px rgba(0,0,0,0.18); cursor:pointer; z-index: 999; }
    @media(max-width: 768px) { .fab { bottom: 80px; } }
    footer { background: transparent; color: var(--muted); padding: 40px 15px; margin-top: 60px; }
    footer h5 { color: var(--primary); }
    footer .form-control { background: var(--card-bg); border-color: var(--glass); color: var(--muted); }
    footer .form-control::placeholder { color: var(--muted); opacity: 0.7; }
    #toastNotification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--primary-700); color: #fff; padding: 14px 22px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: bottom 0.5s cubic-bezier(.17,.67,.26,1.24); z-index: 1000; font-weight: 600; }
    #toastNotification.show { bottom: 20px; }
    #toastNotification.error { background: #e74c3c; }
    #quoteCard { position: fixed; bottom: 20px; right: 20px; max-width: 280px; background: var(--glass); backdrop-filter: blur(8px); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); z-index: 998; transition: all 0.4s ease; opacity: 0.95; }
    #quoteCard p { margin-bottom: 0.25rem; font-size: 0.9rem; color: var(--muted); font-weight: 500; transition: opacity 0.5s ease; }
    #quoteCard small { font-size: 0.8rem; color: var(--primary); font-weight: 700; display: block; text-align: right; transition: opacity 0.5s ease; }
    @media(max-width: 768px) { #quoteCard { left: 0; right: 0; bottom: 0; max-width: 100%; border-radius: 12px 12px 0 0; padding: 12px 16px; text-align: center; } #quoteCard small { text-align: center; } #toastNotification.show { bottom: 70px; } }

    /* --- NEW Feature Styles --- */
    /* Feature 18: Photo Gallery */
    #photoGalleryCarousel .carousel-inner img { height: 300px; object-fit: cover; border-radius: 8px;}
    #photoGalleryCarousel { margin-bottom: 25px; }

    /* Feature 19: Intensity Indicator */
    .intensity-card { background: var(--glass); border-radius: var(--radius); padding: 15px; margin-bottom: 25px; text-align: center; }
    .intensity-card h4 { font-size: 0.9rem; font-weight: 600; color: var(--primary-700); margin-bottom: 10px; }
    [data-theme="dark"] .intensity-card h4 { color: var(--primary); }
    .intensity-scale { display: flex; justify-content: space-between; align-items: flex-end; height: 50px; }
    .intensity-bar { background: var(--glass); width: 8%; border-radius: 4px 4px 0 0; transition: height 0.5s ease-out; }
    /* Example: Highlight bar 7 */
    .intensity-bar:nth-child(7) { background: var(--primary); }

    /* Feature 20: Strava Link Button */
    .strava-link-card { background: #fc4c02; border-radius: var(--radius); padding: 15px; margin-bottom: 25px; text-align: center; }
    .strava-link-card a { color: white; font-weight: 600; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .strava-link-card i { font-size: 1.2rem; }

    /* Feature 21: HR Zone Summary */
    .hr-zone-card { background: var(--glass); border-radius: var(--radius); padding: 20px; margin-bottom: 25px; }
    .hr-zone-card h3 { font-size: 1.1rem; color: var(--primary-700) !important; margin-bottom: 15px; }
    [data-theme="dark"] .hr-zone-card h3 { color: var(--primary) !important; }
    .hr-zone-list .zone-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed var(--glass); }
    .hr-zone-list .zone-item:last-child { border-bottom: none; }
    .hr-zone-list .zone-label { font-weight: 600; }
    .hr-zone-list .zone-time { color: var(--primary); font-weight: 600; }

    /* Feature 22: Post Navigation */
    .post-navigation { display: flex; justify-content: space-between; margin-top: 30px; padding: 20px 0; border-top: 1px solid var(--glass); }
    .nav-link-prev, .nav-link-next { color: var(--muted); text-decoration: none; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
    .nav-link-prev:hover, .nav-link-next:hover { color: var(--primary); }
    .nav-link-next { text-align: right; }
    .nav-link-prev span, .nav-link-next span { display: block; font-size: 0.8rem; opacity: 0.8; }
    .nav-link-disabled { color: var(--glass) !important; pointer-events: none; }

     /* Print Styles */
    @media print {
        /* ... existing print styles ... */
        .post-navigation, #photoGalleryCarousel, .intensity-card, .strava-link-card, .hr-zone-card { display: none !important; } /* Hide new interactive elements */
        .map-overlay { display: none; }
    }
  </style>
</head>

<body>
  <!-- Reading Progress Bar -->
  <div id="readingProgress"></div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top navbar-custom">
    <div class="container-xl d-flex align-items-center justify-content-between"> <div class="d-flex align-items-center"> <a class="navbar-brand d-flex align-items-center" href="index.html"> <img src="images/logo.png" alt="Murad Logo" class="logo-img" onerror="this.onerror=null; this.style.display='none'; document.getElementById('logoFallback').style.display='block';"> <div class="logo-text" id="logoFallback" style="display:none;">Murad</div> </a> <small class="ml-3 dev-note d-none d-md-inline">Details</small> </div> <div class="d-flex align-items-center"> <div class="accent-palette mr-3" role="tablist" aria-label="Accent color"> <div class="accent-dot" data-accent="green" title="Green" style="background:#20c997" aria-checked="true"></div> <div class="accent-dot" data-accent="yellow" title="Yellow" style="background:#f1c40f"></div> <div class="accent-dot" data-accent="red" title="Red" style="background:#e74c3c"></div> </div> <div class="d-flex align-items-center mr-2"> <i id="toggleIcon" class="fas fa-sun mr-2" style="color:var(--primary)"></i> <label style="display:inline-block;cursor:pointer"> <input id="themeSwitch" type="checkbox" style="display:none" aria-label="Toggle dark mode"> <div id="switchVisual" style="width:44px;height:24px;background:rgba(0,0,0,0.06);border-radius:14px;position:relative;"> <div id="switchDot" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;left:3px;top:3px;box-shadow:0 4px 10px rgba(0,0,0,0.12);"></div> </div> </label> </div> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"> <span class="t-icon navbar-toggler-icon" id="hamburgerSvg"></span> </button> </div> <div class="collapse navbar-collapse justify-content-end" id="navbarNav"> <ul class="navbar-nav align-items-center"> <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li> <li class="nav-item"><a class="nav-link" href="athletic.html">Athletics</a></li> <li class="nav-item"><a class="nav-link" href="storytelling.html">Storytelling</a></li> <li class="nav-item"><a class="nav-link" href="projects.html">Projects</a></li> <li class="nav-item"><a class="nav-link" href="achievements.html">Achievements</a></li> <li class="nav-item"><a class="nav-link" href="about.html">Resume</a></li> </ul> </div> </div>
  </nav>

  <!-- Main Post Container -->
  <div class="container-xl post-container">

    <!-- Hero Image & Content -->
    <div id="heroContainer" class="hero-image-container" style="background-image: url('https://placehold.co/1200x400/eee/aaa?text=Loading...')">
      <div class="hero-content">
        <h1 id="postTitle"><i id="activityIcon" class="fas fa-question-circle mr-2"></i>Loading Title...</h1> <!-- Added Icon -->
        <div class="post-meta">
          <span id="postDate"><i class="fas fa-calendar-alt"></i> Loading Date...</span>
          <span id="postReadTime"><i class="fas fa-clock"></i> ... min read</span>
          <!-- Feature 25: Clickable Tag Link -->
          <span id="postTag"><i class="fas fa-tag"></i> <a href="athletic.html" id="tagLink" style="color: inherit; text-decoration: none;">Loading Tag...</a></span>
        </div>
      </div>
    </div>

    <!-- Post Body & Sidebar Content -->
    <div class="post-body">
        <div class="row">
            <!-- Main Content Column -->
            <div class="col-lg-8">
                <div id="mainContent"> <p>Loading post content...</p> </div>

                 <!-- Feature 18: Photo Gallery/Carousel -->
                 <div id="photoGalleryCarousel" class="carousel slide" data-ride="carousel">
                     <ol class="carousel-indicators" id="galleryIndicators"></ol>
                     <div class="carousel-inner" id="galleryInner">
                         <!-- Images will be injected here -->
                     </div>
                     <a class="carousel-control-prev" href="#photoGalleryCarousel" role="button" data-slide="prev">
                         <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="sr-only">Previous</span>
                     </a>
                     <a class="carousel-control-next" href="#photoGalleryCarousel" role="button" data-slide="next">
                         <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="sr-only">Next</span>
                     </a>
                 </div>

                 <div class="focus-callout"> <strong>Training Focus:</strong> Loading focus... </div>
                 <div class="ai-summary-section"> <h3><i class="fas fa-robot mr-1"></i> Quick Summary</h3> <button id="getAiSummaryBtn" class="btn btn-sm btn-outline-primary">Generate Summary</button> <div id="aiSummaryLoading">Generating...</div> <div id="aiSummaryContent"></div> </div>
                 <div class="author-bio"> <img src="images/profile.jpg" alt="Murad Hossain"> <div> <strong>Murad Hossain</strong> <p>Materials Researcher, Endurance Coach...</p> </div> </div>

                 <!-- Feature 22: Post Navigation -->
                 <nav class="post-navigation">
                     <a href="#" id="prevPostLink" class="nav-link-prev nav-link-disabled"><i class="fas fa-arrow-left"></i> <div><span>Previous Post</span><span id="prevPostTitle"></span></div></a>
                     <a href="#" id="nextPostLink" class="nav-link-next nav-link-disabled"><div><span>Next Post</span><span id="nextPostTitle"></span></div> <i class="fas fa-arrow-right"></i></a>
                 </nav>
            </div>

            <!-- Sidebar Column -->
            <div class="col-lg-4">
                 <div class="stats-card"> <h3><i class="fas fa-chart-line mr-1"></i> Key Stats</h3> <div class="stats-grid"> <div class="stat-item"><span class="value" id="statDistance">--</span><span class="label">Distance</span></div> <div class="stat-item"><span class="value" id="statTime">--:--</span><span class="label">Time</span></div> <div class="stat-item"><span class="value" id="statPace">--:--</span><span class="label">Avg Pace</span></div> <div class="stat-item"><span class="value" id="statElevation">--</span><span class="label">Elevation</span></div> </div> </div>

                  <!-- Feature 19: Intensity Indicator -->
                 <div class="intensity-card">
                     <h4><i class="fas fa-tachometer-alt mr-1"></i> Perceived Effort</h4>
                     <div class="intensity-scale" id="intensityScale">
                         <!-- Bars will be generated by JS -->
                     </div>
                     <small id="intensityLabel" class="mt-1 d-block">Moderate (7/10)</small> <!-- Example -->
                 </div>

                 <!-- Feature 21: HR Zone Summary -->
                 <div class="hr-zone-card">
                     <h3><i class="fas fa-heartbeat mr-1"></i> Time in Zones</h3>
                     <div class="hr-zone-list" id="hrZoneList">
                         <div class="zone-item"><span class="zone-label">Zone 1 (Easy)</span><span class="zone-time">--:--</span></div>
                         <div class="zone-item"><span class="zone-label">Zone 2 (Aerobic)</span><span class="zone-time">--:--</span></div>
                         <div class="zone-item"><span class="zone-label">Zone 3 (Tempo)</span><span class="zone-time">--:--</span></div>
                         <div class="zone-item"><span class="zone-label">Zone 4 (Threshold)</span><span class="zone-time">--:--</span></div>
                         <div class="zone-item"><span class="zone-label">Zone 5 (Max)</span><span class="zone-time">--:--</span></div>
                     </div>
                 </div>


                 <div class="map-placeholder">
                     <a href="#" id="mapLink" target="_blank" style="display: block; position: relative;"> <!-- Wrap in link -->
                         <img src="https://placehold.co/400x250/d3e4f0/888?text=Route+Map+Placeholder" alt="Route Map Placeholder">
                         <!-- Feature 23: Interactive Map Overlay -->
                         <div class="map-overlay"><i class="fas fa-search-plus"></i></div>
                     </a>
                     <p>Activity Route Overview</p>
                 </div>

                  <!-- Feature 20: Strava Link Button -->
                 <div class="strava-link-card" id="stravaCard" style="display: none;"> <!-- Hidden by default -->
                    <a href="#" id="stravaLink" target="_blank">
                        <i class="fab fa-strava"></i> View on Strava
                    </a>
                 </div>


                 <div class="info-card"> <i class="fas fa-shoe-prints"></i> <div> <h4>Gear Used</h4> <p id="gearInfo">Loading...</p> </div> </div>
                 <div class="info-card"> <i class="fas fa-cloud-sun"></i> <div> <h4>Conditions</h4> <p id="weatherInfo">Loading...</p> </div> </div>
            </div>
        </div>
    </div>

    <!-- Like & Share Actions -->
    <div class="post-actions"> <button class="like-btn" id="likeBtn" data-id=""> <i class="far fa-heart"></i> <span class="like-count">0</span> Likes </button> <button class="share-btn" id="shareBtn" data-url="" data-title="" data-text=""> <i class="fas fa-share-alt"></i> Share </button> </div>
  </div>

   <!-- Related Posts -->
   <section class="container-xl related-posts"> <h2><i class="fas fa-stream mr-1"></i> You Might Also Like</h2> <div id="relatedPostsGrid" class="row"> <!-- Changed to row for Bootstrap columns --> <!-- Skeletons --> <div class="col-lg-4 col-md-6 mb-4"><div class="blog-card-v2 skeleton-card h-100"><div class="skeleton-image"></div><div class="blog-card-v2-content"><div class="skeleton-line" style="width: 60%;"></div><div class="skeleton-line" style="width: 90%;"></div><div class="skeleton-line" style="width: 100%; height: 20px; margin-top: 10px;"></div><div class="blog-card-v2-footer" style="border: none; padding-top: 10px;"><div class="skeleton-line" style="width: 50px; height: 30px;"></div><div class="skeleton-line" style="width: 100px; height: 30px;"></div></div></div></div></div> <div class="col-lg-4 col-md-6 mb-4"><div class="blog-card-v2 skeleton-card h-100"><div class="skeleton-image"></div><div class="blog-card-v2-content"><div class="skeleton-line" style="width: 60%;"></div><div class="skeleton-line" style="width: 90%;"></div><div class="skeleton-line" style="width: 100%; height: 20px; margin-top: 10px;"></div><div class="blog-card-v2-footer" style="border: none; padding-top: 10px;"><div class="skeleton-line" style="width: 50px; height: 30px;"></div><div class="skeleton-line" style="width: 100px; height: 30px;"></div></div></div></div></div> <div class="col-lg-4 col-md-6 mb-4"><div class="blog-card-v2 skeleton-card h-100"><div class="skeleton-image"></div><div class="blog-card-v2-content"><div class="skeleton-line" style="width: 60%;"></div><div class="skeleton-line" style="width: 90%;"></div><div class="skeleton-line" style="width: 100%; height: 20px; margin-top: 10px;"></div><div class="blog-card-v2-footer" style="border: none; padding-top: 10px;"><div class="skeleton-line" style="width: 50px; height: 30px;"></div><div class="skeleton-line" style="width: 100px; height: 30px;"></div></div></div></div></div> </div> </section>

   <!-- Comment Section -->
   <section class="container-xl comment-section">
       <h2><i class="fas fa-comments mr-1"></i> Comments <span id="commentCount" style="font-size: 1rem; color: var(--muted); font-weight: 500;">(0)</span></h2> <!-- Feature 26 -->
       <div style="max-width: 700px; margin: auto;"> <form id="comment-form" class="mb-4"> <div class="form-group"><input type="text" class="form-control" id="comment-author" placeholder="Your Name" required></div> <div class="form-group"><textarea class="form-control" id="comment-content" rows="3" placeholder="Your Comment" required></textarea></div> <button type="submit" class="btn btn-primary"> <span id="comment-submit-text">Submit Comment</span> <span id="comment-submit-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span> </button> </form> <div id="confirmation-message" class="alert alert-success" role="alert" style="display: none;">Comment added!</div> <div id="comment-list" class="list-group mt-4"> <li class="list-group-item">Loading comments...</li> </div> </div>
   </section>

  <!-- Footer -->
<footer id="contact">
  <div class="container-xl">
    <div class="row">
      <!-- Left: Contact Form -->
      <div class="col-md-6">
        <h5>Contact me</h5>
        <form action="https://formspree.io/f/mwpkvrvr" method="POST" id="mainContact">
          <input class="form-control mb-2" name="name" id="cname" placeholder="Name" required>
          <input class="form-control mb-2" name="email" id="cemail" placeholder="Email" type="email" required>
          <textarea class="form-control mb-2" name="message" id="cmsg" rows="3"
            placeholder="Your message, story idea, or volunteer interest..." required></textarea>
          <button class="btn btn-primary" type="submit">Send Message</button>
        </form>
      </div>

      <!-- Right: Social Links -->
      <div class="col-md-6 text-right d-none d-md-block">
        <h5>Connect Socially</h5>
        <div style="font-size:1.2rem; gap:10px; display:inline-flex; align-items:center;">
          <a href="https://www.facebook.com/murad4231" target="_blank" class="text-decoration-none text-muted">
            <i class="bi bi-facebook"></i>
          </a>
          <a href="https://www.linkedin.com/in/muradhossain42" target="_blank" class="text-decoration-none text-muted">
            <i class="bi bi-linkedin"></i>
          </a>
          <a href="mailto:muradcu42@gmail.com" class="text-decoration-none text-muted">
            <i class="bi bi-envelope"></i>
          </a>
        </div>
        <p class="mt-3 dev-note">Address: Lakshmipur, Bangladesh</p>
        <p class="mt-2 dev-note">#TrihardMurad</p>
      </div>
    </div>

    <!-- Footer bottom -->
    <div class="text-center mt-4 dev-note">
      <a href="admin.html" style="text-decoration: none; color: inherit;" title="Admin Section">&copy; 2025</a>
      Murad Hossain â€” Built with Energy.
    </div>
  </div>
</footer>

  <!-- FLOATING ELEMENTS (Consistent) -->
  <div id="quoteCard"> <p id="quoteText">Loading...</p> <small id="quoteAuthor"></small> </div>
  <div id="toastNotification"></div>
  <div class="fab" id="scrollTopFab" title="Scroll to top" style="display: none;"> <i class="fas fa-arrow-up"></i> </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Firebase Imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, limit, where, updateDoc, increment, orderBy, serverTimestamp, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'; // Added getCountFromServer

    // Firebase config
    const firebaseConfig = { apiKey: "AIzaSyBnDhuKL60HNcX40JI9zQ6YIZDr1hbMZHc", authDomain: "trihardmurad.firebaseapp.com", projectId: "trihardmurad", storageBucket: "trihardmurad.appspot.com", messagingSenderId: "146538214416", appId: "1:146538214416:web:0d7ad5834eb432c385c695", measurementId: "G-GQNJV0VQQQ" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const POSTS_COLLECTION = "athleticPosts";

    // Global State & Elements
    let currentPostData = null;
    const postId = new URLSearchParams(window.location.search).get('id');
    const likedPostsStoreKey = 'athleticLikes';

    const heroContainer = document.getElementById('heroContainer');
    const postTitleEl = document.getElementById('postTitle');
    const postDateEl = document.getElementById('postDate');
    const postReadTimeEl = document.getElementById('postReadTime');
    const postTagEl = document.getElementById('postTag');
    const mainContentEl = document.getElementById('mainContent');
    const likeBtn = document.getElementById('likeBtn');
    const likeCountSpan = likeBtn.querySelector('.like-count');
    const shareBtn = document.getElementById('shareBtn');
    const relatedPostsGrid = document.getElementById('relatedPostsGrid');
    const commentForm = document.getElementById('comment-form');
    const commentListEl = document.getElementById('comment-list');
    const readingProgressBar = document.getElementById('readingProgress');
    const getAiSummaryBtn = document.getElementById('getAiSummaryBtn');
    const aiSummaryContentEl = document.getElementById('aiSummaryContent');
    const aiSummaryLoadingEl = document.getElementById('aiSummaryLoading');
    const statDistance = document.getElementById('statDistance');
    const statTime = document.getElementById('statTime');
    const statPace = document.getElementById('statPace');
    const statElevation = document.getElementById('statElevation');
    const gearInfoEl = document.getElementById('gearInfo');
    const weatherInfoEl = document.getElementById('weatherInfo');
    const focusCalloutEl = document.querySelector('.focus-callout');
    const galleryIndicators = document.getElementById('galleryIndicators'); // NEW
    const galleryInner = document.getElementById('galleryInner'); // NEW
    const intensityScale = document.getElementById('intensityScale'); // NEW
    const intensityLabel = document.getElementById('intensityLabel'); // NEW
    const stravaCard = document.getElementById('stravaCard'); // NEW
    const stravaLink = document.getElementById('stravaLink'); // NEW
    const hrZoneList = document.getElementById('hrZoneList'); // NEW
    const prevPostLink = document.getElementById('prevPostLink'); // NEW
    const nextPostLink = document.getElementById('nextPostLink'); // NEW
    const prevPostTitle = document.getElementById('prevPostTitle'); // NEW
    const nextPostTitle = document.getElementById('nextPostTitle'); // NEW
    const tagLink = document.getElementById('tagLink'); // NEW
    const commentCountSpan = document.getElementById('commentCount'); // NEW
    const activityIconEl = document.getElementById('activityIcon'); // NEW
    const mapLink = document.getElementById('mapLink'); // NEW


    // Helper Functions
    const calculateReadingTime = (text = '') => { const w = text.replace(/<[^>]*>/g, ' ').split(/\s+/).length; return Math.ceil(w / 200) || 1; };
    const formatFirestoreTimestamp = (timestamp) => { return timestamp?.toDate ? timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '---'; };

    // Toast Notification
    const toastEl = document.getElementById('toastNotification'); let toastTimeout; function showToast(msg, isError=false){ clearTimeout(toastTimeout); toastEl.textContent=msg; isError?toastEl.classList.add('error'):toastEl.classList.remove('error'); toastEl.classList.add('show'); toastTimeout=setTimeout(()=>toastEl.classList.remove('show'),3000); }

    // Like Button Logic
    const likedPostsStore = { key: likedPostsStoreKey, getAll: () => JSON.parse(localStorage.getItem(likedPostsStore.key)) || {}, has: (id) => !!likedPostsStore.getAll()[id], add: (id) => { let l = likedPostsStore.getAll(); l[id] = true; localStorage.setItem(likedPostsStore.key, JSON.stringify(l)); }, remove: (id) => { let l = likedPostsStore.getAll(); delete l[id]; localStorage.setItem(likedPostsStore.key, JSON.stringify(l)); } };
    function updateLikeButtonUI(postId, count) { if (!likeBtn) return; likeCountSpan.textContent = count || 0; likeBtn.dataset.id = postId; if (likedPostsStore.has(postId)) { likeBtn.classList.add('liked'); likeBtn.querySelector('.fa-heart').classList.replace('far', 'fas'); } else { likeBtn.classList.remove('liked'); likeBtn.querySelector('.fa-heart').classList.replace('fas', 'far'); } }
    async function handleLikeClick() { if (!currentPostData || !postId || likedPostsStore.has(postId)) { if(currentPostData) showToast("Already liked!"); return; } likedPostsStore.add(postId); const newCount = (currentPostData.likeCount || 0) + 1; updateLikeButtonUI(postId, newCount); currentPostData.likeCount = newCount; try { const postRef = doc(db, POSTS_COLLECTION, postId); await updateDoc(postRef, { likeCount: increment(1) }); } catch (err) { console.error("Like error:", err); likedPostsStore.remove(postId); currentPostData.likeCount--; updateLikeButtonUI(postId, currentPostData.likeCount); showToast("Like failed.", true); } }
    if(likeBtn) likeBtn.addEventListener('click', handleLikeClick);

    // Unified Share Logic
    function updateShareButton(post) { if (!shareBtn || !post) return; const fullpostUrl = `${location.pathname}?id=${encodeURIComponent(postId)}`; const title = post.title || 'Check out this post'; const text = (post.content || '').replace(/<[^>]*>/g, '').slice(0, 150) + "..."; shareBtn.dataset.url = fullpostUrl; shareBtn.dataset.title = title; shareBtn.dataset.text = text; }
    if(shareBtn) shareBtn.addEventListener('click', async () => { const url = location.origin + shareBtn.dataset.url; const title = shareBtn.dataset.title; const text = shareBtn.dataset.text; if (navigator.share) { try { await navigator.share({ title, text, url }); } catch (err) {} } else { try { const ta = document.createElement('textarea'); ta.value = url; ta.style.position='absolute'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('Link copied!'); } catch (err) { showToast('Copy failed.', true); } } });

    // Reading Progress Bar Logic
    function updateProgressBar() { if (!mainContentEl || !readingProgressBar) return; const navHeightString = getComputedStyle(document.documentElement).getPropertyValue('--nav-height').trim(); const navHeight = parseFloat(navHeightString) || 64; const contentHeight = mainContentEl.offsetHeight; const windowHeight = window.innerHeight; const contentTop = mainContentEl.offsetTop; const scrollY = window.scrollY; const scrollRelativeToContent = scrollY - contentTop + navHeight; const scrollableHeight = contentHeight - (windowHeight * 0.8); let progress = 0; if (scrollableHeight > 0 && scrollRelativeToContent > 0) { progress = Math.min(100, Math.max(0, (scrollRelativeToContent / scrollableHeight) * 100)); } else if (scrollRelativeToContent >= scrollableHeight) { progress = 100; } readingProgressBar.style.width = `${progress}%`; }
    window.addEventListener('scroll', updateProgressBar); window.addEventListener('resize', updateProgressBar);

     // --- NEW: Update Activity Icon ---
    function updateActivityIcon(tag) {
        let iconClass = 'fa-question-circle'; // Default
        const lowerTag = (tag || '').toLowerCase();
        if (lowerTag.includes('run')) iconClass = 'fa-running';
        else if (lowerTag.includes('cycl') || lowerTag.includes('bik')) iconClass = 'fa-biking';
        else if (lowerTag.includes('swim')) iconClass = 'fa-swimmer';
        else if (lowerTag.includes('triathlon')) iconClass = 'fa-universal-access'; // Example
        if (activityIconEl) activityIconEl.className = `fas ${iconClass} mr-2`;
    }

    // --- NEW: Update Intensity Indicator ---
    function updateIntensityIndicator(intensity) {
         if (!intensityScale || !intensityLabel) return;
         intensityScale.innerHTML = ''; // Clear previous bars
         const intensityValue = parseInt(intensity) || 0; // Default to 0 if invalid
         const intensityText = intensity?.split('/')[1] ? `(${intensity})` : '(Not Specified)'; // Get full text like 7/10

         for(let i = 1; i <= 10; i++) {
            const bar = document.createElement('div');
            bar.className = 'intensity-bar';
            const heightPercent = Math.max(10, i * 9); // Min height 10%, max 90%
            bar.style.height = `${heightPercent}%`;
            if (i === intensityValue) {
                bar.style.backgroundColor = 'var(--primary)'; // Highlight the correct bar
            }
            intensityScale.appendChild(bar);
         }
         intensityLabel.textContent = `Perceived Effort ${intensityText}`;
    }

    // --- NEW: Update HR Zone Summary ---
     function updateHrZoneSummary(zones) { // Expects an object like { z1: 'hh:mm', z2: 'hh:mm', ... }
        if (!hrZoneList || !zones) return;
        const zoneMap = { z1: 'Zone 1 (Easy)', z2: 'Zone 2 (Aerobic)', z3: 'Zone 3 (Tempo)', z4: 'Zone 4 (Threshold)', z5: 'Zone 5 (Max)' };
        hrZoneList.innerHTML = ''; // Clear defaults
        Object.entries(zoneMap).forEach(([key, label]) => {
            const time = zones[key] || '--:--';
            const item = document.createElement('div');
            item.className = 'zone-item';
            item.innerHTML = `<span class="zone-label">${label}</span><span class="zone-time">${time}</span>`;
            hrZoneList.appendChild(item);
        });
    }

    // --- NEW: Populate Photo Gallery ---
    function populateGallery(imageUrls) { // Expects an array of image URLs
        if (!galleryIndicators || !galleryInner || !imageUrls || imageUrls.length === 0) {
           if(document.getElementById('photoGalleryCarousel')) document.getElementById('photoGalleryCarousel').style.display = 'none'; // Hide if no images
           return;
        }
         if(document.getElementById('photoGalleryCarousel')) document.getElementById('photoGalleryCarousel').style.display = 'block'; // Show if images exist

        galleryIndicators.innerHTML = '';
        galleryInner.innerHTML = '';

        imageUrls.forEach((url, index) => {
            // Indicator
            const indicator = document.createElement('li');
            indicator.dataset.target = '#photoGalleryCarousel';
            indicator.dataset.slideTo = index;
            if (index === 0) indicator.classList.add('active');
            galleryIndicators.appendChild(indicator);

            // Image Item
            const item = document.createElement('div');
            item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
            item.innerHTML = `<img src="${url}" class="d-block w-100" alt="Activity image ${index + 1}" onerror="this.onerror=null; this.src='https://placehold.co/800x300/eee/aaa?text=Image+Error';">`;
            galleryInner.appendChild(item);
        });
    }

    // Load Post Content (Modified to include new features)
    async function loadPost() {
        if (!postId) { mainContentEl.innerHTML = '<p class="text-danger">Error: Post ID not found.</p>'; document.title = "Error"; return; }
        try {
            const postRef = doc(db, POSTS_COLLECTION, postId);
            const postSnap = await getDoc(postRef);
            if (postSnap.exists()) {
                currentPostData = { id: postSnap.id, ...postSnap.data() };
                document.title = currentPostData.title || "Athletic Post";
                heroContainer.style.backgroundImage = `url('${currentPostData.imageUrl || 'https://placehold.co/1200x400/eee/aaa?text=Activity'}')`;
                postTitleEl.textContent = currentPostData.title || 'Untitled Post';
                postDateEl.innerHTML = `<i class="fas fa-calendar-alt"></i> ${formatFirestoreTimestamp(currentPostData.date)}`;
                postReadTimeEl.innerHTML = `<i class="fas fa-clock"></i> ${calculateReadingTime(currentPostData.content)} min read`;
                postTagEl.innerHTML = `<i class="fas fa-tag"></i> <a href="athletic.html?tag=${encodeURIComponent(currentPostData.tag || 'General')}" id="tagLink" style="color: inherit; text-decoration: none;">${currentPostData.tag || 'General'}</a>`; // Clickable Tag
                updateActivityIcon(currentPostData.tag); // Update icon based on tag
                let contentHTML = currentPostData.content || '<p>No content available.</p>';
                if (!contentHTML.startsWith('<p>') && !contentHTML.startsWith('<h') && !contentHTML.startsWith('<block')) { contentHTML = `<p>${contentHTML}</p>`; }
                mainContentEl.innerHTML = contentHTML;
                statDistance.textContent = currentPostData.distance ?? '--'; statTime.textContent = currentPostData.time ?? '--:--'; statPace.textContent = currentPostData.pace ?? '--:--'; statElevation.textContent = currentPostData.elevation ?? '--';
                gearInfoEl.textContent = currentPostData.gear ?? 'Not specified'; weatherInfoEl.textContent = currentPostData.weather ?? 'Not specified';
                if(focusCalloutEl && currentPostData.trainingFocus) { focusCalloutEl.innerHTML = `<strong>Training Focus:</strong> ${currentPostData.trainingFocus}`; }
                else if(focusCalloutEl) { focusCalloutEl.style.display = 'none'; }
                updateIntensityIndicator(currentPostData.intensity); // Update intensity
                updateHrZoneSummary(currentPostData.hrZones); // Update HR Zones
                 // Populate Gallery
                populateGallery(currentPostData.galleryImages); // Assumes field name is galleryImages (array of URLs)

                 // Show Strava Link if available
                if (stravaCard && stravaLink && currentPostData.stravaUrl) {
                    stravaLink.href = currentPostData.stravaUrl;
                    stravaCard.style.display = 'block';
                } else if(stravaCard) {
                     stravaCard.style.display = 'none';
                }

                 // Update Map Link if available
                 if(mapLink && currentPostData.mapUrl) {
                     mapLink.href = currentPostData.mapUrl;
                 } else if (mapLink) {
                      mapLink.removeAttribute('href'); // Make it unclickable if no URL
                      mapLink.style.cursor = 'default';
                 }


                updateLikeButtonUI(postId, currentPostData.likeCount || 0);
                updateShareButton(currentPostData);
                loadComments(postId);
                loadRelatedPosts(currentPostData.tag, postId);
                loadPostNavigation(currentPostData.date); // Load Prev/Next
                setTimeout(updateProgressBar, 100);
            } else { mainContentEl.innerHTML = '<p class="text-danger">Error: Post not found.</p>'; document.title = "Error"; }
        } catch (error) { console.error("Load post error:", error); mainContentEl.innerHTML = '<p class="text-danger">Error loading content.</p>'; document.title = "Error"; }
    }

    // Load Related Posts (Increased to 6)
    async function loadRelatedPosts(tag, currentId) {
        relatedPostsGrid.innerHTML = ''; // Clear existing
        try {
            // Fetch 7 initially to account for current post
            const q = query(collection(db, POSTS_COLLECTION), orderBy("date", "desc"), limit(7));
            const snap = await getDocs(q);
            let count = 0;
            snap.docs.forEach(doc => {
                if (doc.id !== currentId && count < 6) { // Exclude current, limit to 6
                    const post = { id: doc.id, ...doc.data() };
                    // ... (rest of the rendering logic is the same as before) ...
                    const title=post.title||''; const excerpt=(post.content||'').replace(/<[^>]*>/g,'').slice(0,80); const img=post.imageUrl||'https://placehold.co/800x400/eee/aaa?text=Related'; const date=formatFirestoreTimestamp(post.date); const url=`athletic-fullpost.html?id=${encodeURIComponent(post.id)}`; const likes=post.likeCount||0; const liked=likedPostsStore.has(post.id); const icon=liked?'fas':'far'; const readT=calculateReadingTime(post.content); const readTStr=`${readT} min read`; const wrap=document.createElement('div'); wrap.className='col-lg-4 col-md-6 mb-4'; wrap.innerHTML=`<article class="blog-card-v2 h-100"><div class="blog-card-v2-image" style="background-image: url('${img}');"><span class="blog-card-v2-tag">#${post.tag||'General'}</span></div><div class="blog-card-v2-content"><div class="blog-card-v2-meta"><span>${date}</span><span><i class="fas fa-clock" style="opacity: 0.7; margin-right: 4px;"></i>${readTStr}</span></div><h6 class="blog-card-v2-title">${title}</h6><p class="blog-card-v2-excerpt">${excerpt}...</p><div class="blog-card-v2-footer"><button class="like-btn ${liked?'liked':''}" data-id="${post.id}" onclick="handleRelatedLikeClick(this)"><i class="${icon} fa-heart"></i> <span class="like-count">${likes}</span></button><a class="btn btn-sm btn-outline-primary" href="${url}">Read More</a></div></div></article>`; relatedPostsGrid.appendChild(wrap);
                    count++;
                }
            });
            if (count === 0) { relatedPostsGrid.innerHTML = '<p class="col-12 text-center text-muted">No recent posts found.</p>'; } // Updated message

        } catch (error) {
            console.error("Error loading related posts:", error);
            relatedPostsGrid.innerHTML = '<p class="col-12 text-center text-danger">Could not load related posts.</p>';
        }
    }
    window.handleRelatedLikeClick = async function(buttonElement) { /* ... same code ... */ const id=buttonElement.dataset.id; if(!id||likedPostsStore.has(id)){if(id)showToast("Already liked!");return;} likedPostsStore.add(id); buttonElement.classList.add('liked'); buttonElement.querySelector('.fa-heart').classList.replace('far','fas'); const span=buttonElement.querySelector('.like-count'); const count=parseInt(span.textContent,10); span.textContent=count+1; try { const ref=doc(db,POSTS_COLLECTION,id); await updateDoc(ref,{likeCount:increment(1)}); } catch(err){ console.error("Rel like error:",err); likedPostsStore.remove(id); buttonElement.classList.remove('liked'); buttonElement.querySelector('.fa-heart').classList.replace('fas','far'); span.textContent=count; showToast("Like failed.",true); } }

    // --- NEW: Load Post Navigation ---
    async function loadPostNavigation(currentPostDate) {
        if (!currentPostDate) return;
        try {
            // Get previous post (older)
            const prevQuery = query(collection(db, POSTS_COLLECTION), where("date", "<", currentPostDate), orderBy("date", "desc"), limit(1));
            const prevSnap = await getDocs(prevQuery);
            if (!prevSnap.empty) {
                const prevPost = { id: prevSnap.docs[0].id, ...prevSnap.docs[0].data() };
                prevPostLink.href = `athletic-fullpost.html?id=${prevPost.id}`;
                prevPostTitle.textContent = prevPost.title.slice(0, 30) + (prevPost.title.length > 30 ? '...' : '');
                prevPostLink.classList.remove('nav-link-disabled');
            } else {
                 prevPostLink.classList.add('nav-link-disabled');
                 prevPostTitle.textContent = 'No Older Post';
            }

            // Get next post (newer)
            const nextQuery = query(collection(db, POSTS_COLLECTION), where("date", ">", currentPostDate), orderBy("date", "asc"), limit(1));
            const nextSnap = await getDocs(nextQuery);
            if (!nextSnap.empty) {
                const nextPost = { id: nextSnap.docs[0].id, ...nextSnap.docs[0].data() };
                nextPostLink.href = `athletic-fullpost.html?id=${nextPost.id}`;
                nextPostTitle.textContent = nextPost.title.slice(0, 30) + (nextPost.title.length > 30 ? '...' : '');
                nextPostLink.classList.remove('nav-link-disabled');
            } else {
                 nextPostLink.classList.add('nav-link-disabled');
                 nextPostTitle.textContent = 'No Newer Post';
            }
        } catch (error) {
            console.error("Error loading post navigation:", error);
             prevPostLink.classList.add('nav-link-disabled'); prevPostTitle.textContent = 'Error';
             nextPostLink.classList.add('nav-link-disabled'); nextPostTitle.textContent = 'Error';
        }
    }


    // --- Load Comments (Added Count Update) ---
    async function loadComments(postId) {
        commentListEl.innerHTML='<li class="list-group-item">Loading comments...</li>';
        commentCountSpan.textContent = '(...)'; // Loading state for count
        try {
            const commentsRef = collection(db, POSTS_COLLECTION, postId, "comments");
            const q = query(commentsRef, orderBy("date", "desc"));
            const commentsSnap = await getDocs(q);

            // Get count separately (more efficient for large collections)
            const countQuery = query(commentsRef); // Simple query just for count
            const countSnapshot = await getCountFromServer(countQuery);
            const count = countSnapshot.data().count;
            commentCountSpan.textContent = `(${count})`; // Update count

            commentListEl.innerHTML=''; // Clear loading
            if (commentsSnap.empty) {
                commentListEl.innerHTML='<li class="list-group-item text-muted">Be the first to comment!</li>';
            } else {
                commentsSnap.docs.forEach(d=>{ const c=d.data(); const el=document.createElement('li'); el.className='list-group-item'; el.innerHTML=`<h5>${c.author||'Anon'}</h5><p>${c.content||''}</p><small class="text-muted">${formatFirestoreTimestamp(c.date)}</small>`; commentListEl.appendChild(el); });
            }
        } catch(e){ console.error("Comment load error:",e); commentListEl.innerHTML='<li class="list-group-item text-danger">Could not load.</li>'; commentCountSpan.textContent = '(Error)'; }
    }

    // Comment Form Submission (Consistent)
    commentForm.addEventListener('submit', async (e) => { /* ... same code ... */ e.preventDefault(); const authorInput=document.getElementById('comment-author'); const contentInput=document.getElementById('comment-content'); const submitBtn=commentForm.querySelector('button[type="submit"]'); const submitText=document.getElementById('comment-submit-text'); const submitSpinner=document.getElementById('comment-submit-spinner'); const confirmationMsg=document.getElementById('confirmation-message'); const author=authorInput.value.trim(); const content=contentInput.value.trim(); if(!author||!content){showToast("Name & comment required.",true);return;} submitText.style.display='none'; submitSpinner.style.display='inline-block'; submitBtn.disabled=true; try { const ref=collection(db,POSTS_COLLECTION,postId,"comments"); await addDoc(ref,{author,content,date:serverTimestamp()}); commentForm.reset(); confirmationMsg.style.display='block'; setTimeout(()=>confirmationMsg.style.display='none',3000); loadComments(postId); } catch(error){ console.error("Comment submit error:",error); showToast("Failed to submit.",true); } finally { submitText.style.display='inline-block'; submitSpinner.style.display='none'; submitBtn.disabled=false; } });

    // --- Gemini API for AI Summary (Consistent) ---
    const geminiApiKey = ""; const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`; const geminiSystemPromptSummary = "You are a helpful assistant. Summarize the following athletic activity log or blog post concisely in 2-3 bullet points, highlighting the key aspects or outcomes. Do not add greetings or introductory phrases.";
    async function fetchWithRetry(url, options, retries = 3, delay = 1000) { /* ... same */ for(let i=0;i<retries;i++){ try { const r = await fetch(url,options); if(r.ok) return r.json(); if(r.status >= 400 && r.status < 500) throw new Error(`Client error: ${r.status}`); } catch(e){} await new Promise(res => setTimeout(res, delay)); delay*=2; } throw new Error('API fetch failed.'); }
    async function callGeminiApiForSummary(textToSummarize) { /* ... same */ const payload={contents:[{parts:[{text:`Summarize this: ${textToSummarize}`}]}],systemInstruction:{parts:[{text:geminiSystemPromptSummary}]},}; const options={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}; const result=await fetchWithRetry(geminiApiUrl,options); const candidate=result.candidates?.[0]; if(candidate?.content?.parts?.[0]?.text){return candidate.content.parts[0].text;} else{throw new Error('Invalid API summary response.');}}
    async function handleGetAiSummary() { /* ... same formatting logic ... */ if(!currentPostData||!currentPostData.content){showToast("Cannot summarize.",true);return;} getAiSummaryBtn.style.display='none'; aiSummaryLoadingEl.style.display='block'; aiSummaryContentEl.style.display='none'; try { const tempDiv=document.createElement('div'); tempDiv.innerHTML=currentPostData.content; const plainText=tempDiv.textContent||tempDiv.innerText||""; const summary=await callGeminiApiForSummary(plainText.slice(0,4000)); let formattedSummary=summary.trim(); if(!formattedSummary.startsWith('*')&&!formattedSummary.startsWith('-')&&formattedSummary.includes('\n')){formattedSummary=formattedSummary.split('\n').map(l=>`â€¢ ${l.trim()}`).join('<br>');} else if(!formattedSummary.startsWith('*')&&!formattedSummary.startsWith('-')){formattedSummary=`â€¢ ${formattedSummary}`;} else {formattedSummary=formattedSummary.replace(/\n/g,'<br>');} aiSummaryContentEl.innerHTML=formattedSummary; aiSummaryContentEl.style.display='block'; } catch(err){ console.error("AI Summary Error:",err); aiSummaryContentEl.textContent='Summary unavailable.'; aiSummaryContentEl.style.display='block'; } finally { aiSummaryLoadingEl.style.display='none'; } }
    if(getAiSummaryBtn) getAiSummaryBtn.addEventListener('click', handleGetAiSummary);

    // --- Theme & Accent (Consistent) ---
    const accentDots = document.querySelectorAll('.accent-dot');
    function setAccent(key){ document.documentElement.setAttribute('data-accent', key); localStorage.setItem('site-accent', key); updateThemeStyles(); accentDots.forEach(d=>d.setAttribute('aria-checked', d.dataset.accent === key)); drawHamburger(); }
    function updateThemeStyles(){ const comp=getComputedStyle(document.documentElement); const p=comp.getPropertyValue('--primary').trim(); const logo=document.querySelector('.logo-img'); if(logo) logo.style.borderColor = p; }
    accentDots.forEach(dot=>dot.addEventListener('click',()=>setAccent(dot.dataset.accent))); const themeSwitch=document.getElementById('themeSwitch'); const switchVisual=document.getElementById('switchVisual'); const switchDot=document.getElementById('switchDot'); const toggleIcon=document.getElementById('toggleIcon');
    function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('site-theme', t); if(t === 'dark'){ if(switchDot) switchDot.style.left='23px'; if(toggleIcon) toggleIcon.className='fas fa-moon mr-2'; } else { if(switchDot) switchDot.style.left='3px'; if(toggleIcon) toggleIcon.className='fas fa-sun mr-2'; } updateThemeStyles(); }
    const storedTheme=localStorage.getItem('site-theme')||'light'; setTheme(storedTheme); const storedAccent=localStorage.getItem('site-accent')||'green'; setAccent(storedAccent);
    if(switchVisual) switchVisual.addEventListener('click',()=>setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'));
    function drawHamburger(){ const accent=getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()||'#20c997'; const svg=`data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cpath stroke='${encodeURIComponent(accent)}' stroke-width='2' d='M3 6h18M3 12h18M3 18h18' stroke-linecap='round'/%3E%3C/svg%3E`; const el=document.getElementById('hamburgerSvg'); if(el){ el.style.backgroundImage=`url("${svg}")`; el.style.backgroundSize='20px 20px'; }} drawHamburger(); window.addEventListener('resize', drawHamburger);

    // --- Floating Quote (Consistent) ---
    const quotes = [ { text: "Pain is temporary. Quitting lasts forever.", author: "L. Armstrong" }, { text: "Courage to start is the miracle.", author: "J. Bingham" }, { text: "Run, walk, crawl; just never give up.", author: "D. Karnazes" }, { text: "It's supposed to be hard.", author: "A League of Their Own" } ];
    const quoteTextEl = document.getElementById('quoteText'); const quoteAuthorEl = document.getElementById('quoteAuthor'); let quoteIndex = 0; function updateQuote(){ if(!quoteTextEl||!quoteAuthorEl) return; quoteTextEl.style.opacity='0'; quoteAuthorEl.style.opacity='0'; setTimeout(()=>{let i=quoteIndex; while(i===quoteIndex) i=Math.floor(Math.random()*quotes.length); quoteIndex=i; quoteTextEl.textContent=`"${quotes[quoteIndex].text}"`; quoteAuthorEl.textContent=`â€” ${quotes[quoteIndex].author}`; quoteTextEl.style.opacity='1'; quoteAuthorEl.style.opacity='1';}, 500); } updateQuote(); setInterval(updateQuote, 8000);

    // --- Scroll-to-Top FAB (Consistent) ---
    const scrollTopFab = document.getElementById('scrollTopFab'); if(scrollTopFab){ window.addEventListener('scroll',()=>{ const show=document.body.scrollTop > 100 || document.documentElement.scrollTop > 100; scrollTopFab.style.display=show?'flex':'none'; scrollTopFab.style.opacity=show?'1':'0'; }); scrollTopFab.addEventListener('click',()=>window.scrollTo({top:0, behavior:'smooth'})); }

    // --- Page Transitions (Consistent) ---
    document.querySelectorAll('a.nav-link, a[href$=".html"]').forEach(a=>{ a.addEventListener('click',(ev)=>{ const href=a.getAttribute('href'); if(!href||href.startsWith('http')||href.startsWith('mailto:')||href.startsWith('#')||a.getAttribute('target')==='_blank') return; ev.preventDefault(); document.documentElement.classList.add('page-fade-out'); setTimeout(()=>location.href=href, 320); }); });

    // --- Contact Form Logic (Footer Only) ---
    window.handleContact = async function(e, formId){ e.preventDefault(); const form = document.getElementById(formId); if (!form) return; const btn = form.querySelector('button[type="submit"]'); const originalText = btn.textContent; btn.disabled = true; btn.textContent = 'Sending...'; try { let name = form.querySelector('#cname').value; let email = form.querySelector('#cemail').value; let message = form.querySelector('#cmsg').value; await addDoc(collection(db,'contacts'), { name, email, message, source: formId, createdAt: new Date().toISOString() }); showToast('Thanks! Message sent.'); form.reset(); } catch(err){ showToast('Send failed.',true); } finally { btn.disabled = false; btn.textContent = originalText; } };
    const footerForm = document.getElementById('mainContact'); if (footerForm) footerForm.addEventListener('submit', (e) => handleContact(e, 'mainContact'));


    // --- Initial Load ---
    loadPost();

  </script>

  <!-- Bootstrap JS (Consistent) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

</body>
</html>

